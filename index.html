<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodle Tehtäväparseri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 p-4 flex items-center justify-between shrink-0">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 text-white p-2 rounded-lg">
                <i data-lucide="calculator" class="w-6 h-6"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800">Moodle Tehtäväparseri</h1>
        </div>
        <div class="text-sm text-slate-500 hidden sm:block">
            Tukee: &&&& oikeat vastaukset, Tehtävä X -otsikot, LaTeX ($$)
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Left Panel: Input -->
        <div class="w-1/2 flex flex-col border-r border-slate-200 bg-white">
            <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="font-semibold text-slate-700 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    Syöte (LLM vastaus)
                </h2>
                <button onclick="clearInput()" class="text-xs text-red-600 hover:text-red-700 font-medium px-2 py-1 rounded hover:bg-red-50">
                    Tyhjennä
                </button>
            </div>
            <textarea id="inputArea" class="flex-1 p-4 resize-none focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500 font-mono text-sm" 
                placeholder="Liitä LLM:n tuottama teksti tähän (sisältäen Tehtävä 1, &&&& merkinnät jne.)..."></textarea>
            
            <div class="p-4 border-t border-slate-200 bg-slate-50">
                <button onclick="processContent()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-sm">
                    <i data-lucide="arrow-right-circle" class="w-5 h-5"></i>
                    Jäsennä tehtävät
                </button>
            </div>
        </div>

        <!-- Right Panel: Output -->
        <div class="w-1/2 flex flex-col bg-slate-50">
            <!-- Tabs -->
            <div class="flex border-b border-slate-200 bg-white shrink-0">
                <button onclick="switchTab('parsed')" id="tab-parsed" class="flex-1 py-3 px-4 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 hover:bg-slate-50 transition-colors">
                    Jäsennetyt kysymykset
                </button>
                <button onclick="switchTab('cleaned')" id="tab-cleaned" class="flex-1 py-3 px-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50 transition-colors">
                    Raakateksti
                </button>
            </div>

            <!-- Content: Parsed Questions -->
            <div id="view-parsed" class="flex-1 overflow-y-auto p-4 space-y-6">
                <!-- Intro Context Card -->
                <div id="contextCard" class="bg-white rounded-lg shadow-sm border-l-4 border-blue-500 p-4 hidden">
                    <div class="flex justify-between items-start mb-2">
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">Johdanto / Konteksti</span>
                        <button onclick="copyContent(this)" class="text-slate-400 hover:text-indigo-600 transition-colors" title="Kopioi">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="prose prose-sm max-w-none text-slate-700 whitespace-pre-wrap font-mono text-xs bg-slate-50 p-2 rounded border border-slate-100 question-content"></div>
                </div>

                <!-- Questions Container -->
                <div id="questionsList" class="space-y-4 pb-10"></div>
            </div>

            <!-- Content: Cleaned Raw Text -->
            <div id="view-cleaned" class="hidden flex-1 overflow-y-auto p-4 space-y-4">
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-sm font-semibold text-slate-700">Siistitty teksti</h3>
                        <button onclick="copyToClipboard('cleanedOutput')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 py-1 px-3 rounded border border-slate-300 transition-colors flex items-center gap-1">
                            <i data-lucide="copy" class="w-3 h-3"></i> Kopioi kaikki
                        </button>
                    </div>
                    <textarea id="cleanedOutput" readonly class="w-full h-[600px] text-sm text-slate-800 bg-slate-50 border border-slate-200 rounded p-3 font-mono focus:outline-none"></textarea>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2 z-50">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
        <span id="toastMsg">Kopioitu leikepöydälle!</span>
    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // --------------------------------------------------------
        // 1. CLEANING LOGIC (Vim Macros & Formatting)
        // --------------------------------------------------------
        function applyReplacements(text) {
            let processed = text;

            // Remove Markdown bold/italic (*)
            processed = processed.replace(/\*/g, '');
            // Remove headers (###)
            processed = processed.replace(/#{2,}\s*/g, '');
            // Remove horizontal rules (---)
            processed = processed.replace(/---/g, '');
            // Fix Math: \times -> \cdot
            processed = processed.replace(/\\times/g, '\\cdot');
            // Fix Euro: € -> \text{€}
            processed = processed.replace(/€/g, '\\text{€}');
            
            // Fix Decimals: 1.5 -> 1,5 (but avoid replacing in headers like A1.3.1)
            // Strategy: replace dot with comma if surrounded by digits
            processed = processed.replace(/(\d)\.(\d)/g, '$1,$2');

            // Double $$ for Moodle
            // Replace single $ with $$ if not already $$
            processed = processed.replace(/(?<!\$)\$(?!\$)/g, '$$$$'); 
            // Fix edge case where $$$$ might happen if logic fails
            processed = processed.replace(/\$\$\$\$/g, '$$$$'); 

            // Normalize newlines
            processed = processed.replace(/\n{3,}/g, '\n\n');
            
            return processed.trim();
        }

        // --------------------------------------------------------
        // 2. PARSING LOGIC
        // --------------------------------------------------------
        function parseQuestions(text) {
            const lines = text.split('\n');
            let context = [];
            let questions = [];
            let currentQuestion = null;
            let currentAnswerTarget = null; // Fix for "last question bug"
            
            // Regex patterns based on your instructions
            // Supports: "Tehtävä 1", "Kysymys 1", "A1.1.1", "1."
            const questionIdRegex = /^(Tehtävä\s+\d+|Kysymys\s+\d+|A\d+(?:[.,]\d+)*)([:.]?)/i;
            const optionRegex = /^([A-D])\./; // Matches A., B., C., D.
            const correctMarkerRegex = /\s*&&&&$/; // Matches &&&& at end of line
            const modelAnswerHeaderRegex = /^(Mallivastaukset|Vastaukset|Selitykset)/i;

            let parsingMode = 'context'; // 'context', 'questions', 'answers'

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                // --- DETECT SECTION CHANGE ---
                if (modelAnswerHeaderRegex.test(line)) {
                    parsingMode = 'answers';
                    // Reset current question so we don't append answer header to it
                    currentQuestion = null; 
                    continue; 
                }

                // --- CONTEXT MODE ---
                if (parsingMode === 'context') {
                    // Check if line starts a question
                    const qMatch = line.match(questionIdRegex);
                    if (qMatch) {
                        parsingMode = 'questions';
                        // Fall through to questions logic
                    } else {
                        context.push(line);
                        continue;
                    }
                }

                // --- QUESTIONS MODE ---
                if (parsingMode === 'questions') {
                    const qMatch = line.match(questionIdRegex);
                    
                    if (qMatch) {
                        // Start New Question
                        if (currentQuestion) questions.push(currentQuestion);
                        
                        // ID is the matched part (e.g. "Tehtävä 1")
                        // Text is the rest. remove colon if present.
                        const id = qMatch[1];
                        let content = line.substring(qMatch[0].length).trim();
                        // Remove leading colon/dot from content if regex caught it in group 2
                        if (content.startsWith(':') || content.startsWith('.')) content = content.substring(1).trim();

                        currentQuestion = {
                            id: id,
                            text: content, 
                            fullText: line, // For "Copy All"
                            options: [],
                            explanation: ''
                        };
                    } else if (optionRegex.test(line)) {
                        // It's an Option (A. B. C. D.)
                        if (currentQuestion) {
                            // Check for correct answer marker &&&&
                            const isCorrect = correctMarkerRegex.test(line);
                            // Remove the marker for display text
                            const cleanOptionText = line.replace(correctMarkerRegex, '').trim();
                            
                            currentQuestion.options.push({
                                raw: line, // Contains &&&&
                                text: cleanOptionText, // No &&&&
                                isCorrect: isCorrect
                            });
                        }
                    } else {
                        // Continuation of question text
                        if (currentQuestion) {
                            // FIX: Check if text is empty before appending newline to avoid initial blank line
                            if (currentQuestion.text && currentQuestion.text.length > 0) {
                                currentQuestion.text += '\n' + line;
                            } else {
                                currentQuestion.text = line;
                            }
                            currentQuestion.fullText += '\n' + line;
                        }
                    }
                }

                // --- ANSWERS MODE ---
                else if (parsingMode === 'answers') {
                    // Try to match an ID (e.g., "Tehtävä 1:")
                    const ansMatch = line.match(questionIdRegex);
                    
                    if (ansMatch) {
                        const qIdRaw = ansMatch[1]; // e.g., "Tehtävä 1"
                        
                        // Find the matching question object
                        // We normalize to handle "Tehtävä 1" vs "Tehtävä 1." loose matching
                        // Also handle A1.1 vs A1,1 conversion issues
                        currentAnswerTarget = questions.find(q => {
                            const normalizedQ = q.id.replace(/[,.]/g, '').toLowerCase();
                            const normalizedA = qIdRaw.replace(/[,.]/g, '').toLowerCase();
                            return normalizedQ === normalizedA;
                        });

                        // If found, append the rest of the line as explanation
                        if (currentAnswerTarget) {
                            let content = line.substring(ansMatch[0].length).trim();
                            if (content.startsWith(':') || content.startsWith('.')) content = content.substring(1).trim();
                            currentAnswerTarget.explanation = content;
                        }
                    } else {
                        // It's a continuation line for the PREVIOUS answer
                        // This fixes the "last question" bug. We keep appending to the last found target.
                        if (currentAnswerTarget) {
                            currentAnswerTarget.explanation += '\n' + line;
                        }
                    }
                }
            }
            // Push the last question if loop finishes
            if (currentQuestion && parsingMode === 'questions') questions.push(currentQuestion);

            return { context: context.join('\n'), questions };
        }

        // --------------------------------------------------------
        // 3. UI RENDERING
        // --------------------------------------------------------

        function processContent() {
            const rawInput = document.getElementById('inputArea').value;
            if (!rawInput) return;

            const cleanedText = applyReplacements(rawInput);
            document.getElementById('cleanedOutput').value = cleanedText;

            const parsedData = parseQuestions(cleanedText);
            renderParsedView(parsedData);
        }

        function renderParsedView(data) {
            const contextCard = document.getElementById('contextCard');
            const questionsList = document.getElementById('questionsList');
            questionsList.innerHTML = '';

            // Render Context
            if (data.context.length > 0) {
                contextCard.classList.remove('hidden');
                contextCard.querySelector('.question-content').textContent = data.context;
            } else {
                contextCard.classList.add('hidden');
            }

            // Render Questions
            data.questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden';
                
                // --- OPTIONS RENDER ---
                let optionsHtml = '';
                if (q.options.length > 0) {
                    optionsHtml = '<div class="mt-4 space-y-2">';
                    
                    const renderOptionRow = (text, isCorrect) => {
                        const borderClass = isCorrect 
                            ? 'border-green-500 bg-green-50 hover:bg-green-100' 
                            : 'border-slate-200 hover:border-indigo-400 hover:bg-indigo-50';
                        
                        const badgeHtml = isCorrect 
                            ? '<span class="text-[10px] font-bold text-green-700 uppercase tracking-wider ml-2 bg-green-200 px-1 rounded">Oikein</span>' 
                            : '';

                        return `
                            <div onclick="copyText('${escapeJs(text)}')" 
                                 class="cursor-pointer group relative p-3 rounded border ${borderClass} transition-all duration-200 shadow-sm select-none"
                                 title="Klikkaa kopioidaksesi">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-mono text-slate-700 group-hover:text-slate-900">${escapeHtml(text)}</span>
                                    ${badgeHtml}
                                </div>
                                <div class="absolute inset-0 rounded ring-2 ring-indigo-500 opacity-0 group-active:opacity-100 transition-opacity pointer-events-none"></div>
                            </div>
                        `;
                    };

                    q.options.forEach(opt => {
                        optionsHtml += renderOptionRow(opt.text, opt.isCorrect);
                    });

                    // ADD 5TH OPTION AUTOMATICALLY
                    optionsHtml += renderOptionRow("Jätän vastaamatta kysymykseen.", false);

                    optionsHtml += '</div>';
                }

                // --- EXPLANATION RENDER ---
                let explanationHtml = '';
                if (q.explanation && q.explanation.trim() !== '') {
                    explanationHtml = `
                        <div class="mt-4 pt-3 border-t border-slate-100">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-xs font-semibold text-slate-500 uppercase">Mallivastaus / Selitys</span>
                                <button onclick="copyText('${escapeJs(q.explanation)}')" class="flex items-center gap-1 text-xs text-indigo-600 hover:text-indigo-800 font-medium py-1 px-2 rounded hover:bg-indigo-50 transition-colors">
                                    <i data-lucide="copy" class="w-3 h-3"></i> Kopioi selitys
                                </button>
                            </div>
                            <div class="p-3 bg-slate-50 rounded border border-slate-200 text-sm font-mono text-slate-700 whitespace-pre-wrap">
                                ${escapeHtml(q.explanation)}
                            </div>
                        </div>
                    `;
                }

                // --- CARD STRUCTURE ---
                card.innerHTML = `
                    <div class="bg-indigo-50 px-4 py-2 border-b border-indigo-100 flex justify-between items-center">
                        <span class="font-bold text-indigo-900 text-sm">${escapeHtml(q.id)}</span>
                        <div class="flex gap-2">
                             <button onclick="copyText('${escapeJs(q.text)}')" class="text-xs bg-white hover:bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-200 shadow-sm transition-colors flex items-center gap-1">
                                <i data-lucide="copy" class="w-3 h-3"></i> Kysymys
                            </button>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="text-slate-800 font-mono text-sm whitespace-pre-wrap">${escapeHtml(q.text)}</div>
                        ${optionsHtml}
                        ${explanationHtml}
                    </div>
                `;
                questionsList.appendChild(card);
            });
            
            // Re-run icons for new elements
            lucide.createIcons();
        }

        // --------------------------------------------------------
        // UTILS
        // --------------------------------------------------------
        
        function switchTab(tabName) {
            const btnCleaned = document.getElementById('tab-cleaned');
            const btnParsed = document.getElementById('tab-parsed');
            const viewCleaned = document.getElementById('view-cleaned');
            const viewParsed = document.getElementById('view-parsed');

            if (tabName === 'cleaned') {
                btnCleaned.classList.add('border-indigo-600', 'text-indigo-600');
                btnCleaned.classList.remove('border-transparent', 'text-slate-500');
                btnParsed.classList.remove('border-indigo-600', 'text-indigo-600');
                btnParsed.classList.add('border-transparent', 'text-slate-500');
                
                viewCleaned.classList.remove('hidden');
                viewParsed.classList.add('hidden');
            } else {
                btnParsed.classList.add('border-indigo-600', 'text-indigo-600');
                btnParsed.classList.remove('border-transparent', 'text-slate-500');
                btnCleaned.classList.remove('border-indigo-600', 'text-indigo-600');
                btnCleaned.classList.add('border-transparent', 'text-slate-500');

                viewParsed.classList.remove('hidden');
                viewCleaned.classList.add('hidden');
            }
        }

        function clearInput() {
            document.getElementById('inputArea').value = '';
            document.getElementById('cleanedOutput').value = '';
            document.getElementById('questionsList').innerHTML = '';
            document.getElementById('contextCard').classList.add('hidden');
        }
        
        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            el.select();
            document.execCommand('copy');
            showToast();
        }

        function copyContent(btn) {
            const text = btn.closest('.rounded-lg').querySelector('.question-content').textContent;
            navigator.clipboard.writeText(text).then(showToast);
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(showToast);
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 2000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function escapeJs(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '');
        }
    </script>
</body>
</html>
